<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Çiftlik</title>

<style>
body{margin:0;overflow:hidden;font-family:Arial}
#camera{width:100vw;height:100vh;overflow:hidden;position:relative}
#world{width:2000px;height:2000px;position:absolute;background:#7ec850}
.player{width:40px;height:40px;border-radius:50%;background:red;position:absolute}
.other{background:blue}
.animal{width:30px;height:30px;border-radius:50%;background:brown;position:absolute}
#ui{position:fixed;top:10px;left:10px;background:#fff;padding:8px;border-radius:8px;z-index:10}
#joystick{position:fixed;bottom:30px;left:30px;width:120px;height:120px;border-radius:50%;background:rgba(0,0,0,.2)}
#stick{width:50px;height:50px;border-radius:50%;background:#444;position:absolute;left:35px;top:35px}
</style>
</head>

<body>

<div id="ui">
<input id="room" placeholder="Oda kodu">
<button onclick="join()">GİR</button>
</div>

<div id="camera">
  <div id="world"></div>
</div>

<div id="joystick"><div id="stick"></div></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, set, onValue, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const firebaseConfig={
 apiKey:"AIzaSyBVajz1TsPuM9a2eiCRsPZpVu3NvSA5l1Y",
 authDomain:"ciftlik-fbced.firebaseapp.com",
 databaseURL:"https://ciftlik-fbced-default-rtdb.firebaseio.com",
 projectId:"ciftlik-fbced",
 appId:"1:585953196707:web:9768d229040ca27755dd16"
};

const app=initializeApp(firebaseConfig);
const db=getDatabase(app);

let room="", me="p"+Math.random().toString(36).slice(2);
let x=1000,y=1000;
const world=document.getElementById("world");
const camera=document.getElementById("camera");

function join(){
 room=document.getElementById("room").value;
 if(!room) return alert("Oda gir");

 set(ref(db,"rooms/"+room+"/players/"+me),{x,y});

 // hayvanlar yoksa oluştur
 set(ref(db,"rooms/"+room+"/animals"),{
  a1:{x:900,y:900},
  a2:{x:1100,y:1000}
 });

 onValue(ref(db,"rooms/"+room),(snap)=>{
  const r=snap.val();
  if(!r) return;

  world.innerHTML="";

  Object.values(r.animals||{}).forEach(a=>{
   const d=document.createElement("div");
   d.className="animal";
   d.style.left=a.x+"px";
   d.style.top=a.y+"px";
   world.appendChild(d);
  });

  Object.entries(r.players||{}).forEach(([id,p])=>{
   const d=document.createElement("div");
   d.className="player"+(id!==me?" other":"");
   d.style.left=p.x+"px";
   d.style.top=p.y+"px";
   world.appendChild(d);
   if(id===me){x=p.x;y=p.y;}
  });

  // kamera takip
  world.style.left = (window.innerWidth/2 - x)+"px";
  world.style.top  = (window.innerHeight/2 - y)+"px";
 });
}

// MOBİL JOYSTICK
const joy=document.getElementById("joystick");
const stick=document.getElementById("stick");

joy.ontouchmove=e=>{
 const r=joy.getBoundingClientRect();
 const t=e.touches[0];
 const dx=t.clientX-r.left-60;
 const dy=t.clientY-r.top-60;

 x+=dx*0.05;
 y+=dy*0.05;

 stick.style.left=dx+60+"px";
 stick.style.top=dy+60+"px";

 if(room) update(ref(db,"rooms/"+room+"/players/"+me),{x,y});
};

joy.ontouchend=()=>{
 stick.style.left="35px";
 stick.style.top="35px";
};
</script>

</body>
</html>
